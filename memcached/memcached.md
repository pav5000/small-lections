# Memcached

Это просто большая мапка в памяти.
Данные хранятся только в пямяти, никакого сброса на диск.
В целом, это можно рассматривать как "ненадежное, но **очень** быстрое key-value хранилище"

## Запускаем

sudo docker run --rm -ti --network host --name memcache memcached memcached -m 64 -vvv

Рассмотрим команду запуска подробнее.
`docker run` -- запустить докер-контейнер
`--rm` -- удалить контейнер при завершении его работы, чтобы не засорять комп
`-ti` -- показать нам консоль
`--network host` -- отключить докеровский NAT, чтобы приложение имело доступ к сети напрямую
`--name memcache` -- назовем наш контейнер memcache
`memcached` -- имя образа, из которого мы создаем контейнер. Это стандартный образ Мемкэша из репы Докера.
`memcached -m 64 -vvv` -- какую команду запустить внутри контейнера. Тут мы запускаем сам мемкэш, говорим ему использовать 65Мб памяти и включить verbose-режим (чтобы он писал о всех операциях в консоль).

Можем еще указать параметры:
`-l 127.0.0.1` -- слушать только локалхост
`-p 11211` -- слушать на определенном порту (11211 принят по-умолчанию)
`-n 48` -- сколько байт синимально аллоцировать под одну запись. Уменьшение этого значения может уменьшить потребление памяти при куче мелких ключей.
`-C` -- выключить Compare and swap (уменьшает размер записи на 8 байт).
`-I 1m` -- размер одного блока в памяти. Одна запись не может быть больше, чем этот размер.

**Важно:** при старте мемкэш сразу занимает всю память, которую мы ему указали в параметре `-m`. Это сделано для оптимизации.

## Смотрим на протокол

Ключ -- текстовая строка длиной до 250 байт. Запрещены контрольные символы и пробелы.
![Джейсон запрещает нам](https://i.imgflip.com/51wax2.jpg | height=250)

Значение -- любые бинарные данные.

# Обзор команд

Сохранение и изменение данных:
- `set` **99% времени используем только ее, тупо создает или заменяет запись**
- `add` сохраняет запись только если такого ключа еще нет
- `replace` сохраняет записть только если такой ключ уже есть
- `append` добавить данные в конец записи
- `prepend` добавить данные в начало записи
- `cas` сохраняет запись только если ее никто не менял со времени последнего чтения
- `delete` удаляет запись (можно выставить задержку удаления)
- `incr/decr` Прибавляет или убавляет число к записи. Работает только если данные в записи это int64 в строковой форме. Прибавить или отнять можно только положительное число. Операция атомарная.

Получение данных:
- `get` **99% времени используем только ее, тупо получаем одну или несколько записей**
- `gets` то же самое, что `get`, но мы получаем еще id для CAS
- `flush_all` убить вообще все данные. При выполнении память освобождается не мгновенно, просто все записи помечаются протухшими.

# Текстовый протокол

Это просто справочно-развлекательный раздел, ибо вручную мы с протоколом обычно не работаем.
Информация здесь для того, чтобы лучше представлять, как клиент в твоей программе работает с мемкешем.

Общий формат команды set: `set key [flags] [exptime] length [noreply]`
Например, попробуем положить запись.
```
$ telnet 127.0.0.1 11211
Trying 127.0.0.1...
Connected to 127.0.0.1.
set testkey 0 60 6
abcdef
STORED
```
Разбор команды:
|                  |                |
| ---------------- |:-------------: |
| ключ             | testkey        |
| флаги            | 0 (без флагов) |
| время протухания | 60 секунд      |
| длина данных     | 6 байт         |
| данные           | abcdef         |

По этому примеру видно, почему в ключе нельзя использовать пробелы и контрольные символы.
При этом, в данных можно использовать любые байты, ибо мы указали их длину и сервер просто будет читать указанное количество байт.
